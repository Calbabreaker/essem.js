/*!
 * essem.js - v0.0.0
 * Compiled Mon, 19 Apr 2021 06:21:01 GMT
 *
 * Free to use under the MIT LICENSE.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ESSEM={})}(this,(function(t){"use strict";function e(t,e,s,r){return new(s||(s=Promise))((function(i,n){function o(t){try{h(r.next(t))}catch(t){n(t)}}function a(t){try{h(r.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((r=r.apply(t,e||[])).next())}))}class s extends Error{constructor(t){super(t),this.name="AssertionError"}}function r(t,e,s){return t.has(e)||t.set(e,new s),t.get(e)}function i(t,e){const s=t[t.length-1];return t[e]=s,t.pop(),s}function n(t){var e;return null!==(e=t.name)&&void 0!==e?e:t}let o;function a(){if(void 0===o){const t=document.createElement("canvas").getContext("webgl2");o=void 0!==t}return o}let h=!1;function c(){h||(console.log("---\n--- essem.js v0.0.0\n---"),h=!0)}function u(t){const e=new Float32Array(4);return t<=16777215?(e[0]=(t>>16&255)/255,e[1]=(t>>8&255)/255,e[2]=(255&t)/255,e[3]=1):(e[0]=(t>>24&255)/255,e[1]=(t>>16&255)/255,e[2]=(t>>8&255)/255,e[3]=(255&t)/255),e}class l{constructor(t){if(!a())throw alert("WebGL2 is not supported in your browser!"),new Error("WebGL2 not supported!");{const e=t.getContext("webgl2");this.gl=e,this.maxTextureSlots=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)}}update(){const t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}set backgroundColor(t){const e=u(t);this.gl.clearColor(e[0],e[1],e[2],e[3])}}class d{constructor(t,e){this.children=new Map,this._active=!1,this._activeSelf=!1,this._destroyed=!0,this._name="",this._parent=null,this._systemIndexMap=new Map,this._tagIndexMap=new Map,this._componentMap=new Map,this.id=t,this._scene=e}addComponent(t){const e=t.constructor.name;return this._componentMap.set(e,t),this.active&&this._scene._entityComponentAdd(this,e),t}removeComponent(t){const e=n(t);this.active&&this._scene._entityComponentRemove(this,e),this._componentMap.delete(e)}hasComponent(t){const e=n(t);return this._componentMap.has(e)}hasAllComponents(t){for(let e=0;e<t.length;e++)if(!this.hasComponent(t[e]))return!1;return!0}getComponent(t){const e=n(t);return this._componentMap.get(e)}addTag(t){if(this.active)return this._scene._entityTagAdd(this,t);this._tagIndexMap.set(t,0)}hasTag(t){return this._tagIndexMap.has(t)}removeTag(t){this.active&&this._scene._entityTagRemove(this,t)}get active(){return this._active}set active(t){this._destroyed||this.active===t||this.parent instanceof d&&!this.parent.active||(this._setActive(t),this._activeSelf=t,this.forEachChildrenRecursive((e=>{e._setActive(t&&e.activeSelf)})))}get activeSelf(){return this._activeSelf}_setActive(t){if(this.active!==t){if(this._active=t,0!==this._componentMap.size)for(const[e]of this._componentMap)t?this._scene._entityComponentAdd(this,e):this._scene._entityComponentRemove(this,e);if(0!==this._tagIndexMap.size)for(const[e]of this._tagIndexMap)t?this.addTag(e):this._scene._entityTagRemove(this,e)}}get parent(){return this._parent}set parent(t){null!==this._parent&&this._parent.children.delete(this._name),null!==t&&t.children.set(this._name,this),this._parent=t}get name(){return this._name}set name(t){this._name=t,this.parent=this._parent}forEachParent(t){this._parent instanceof d&&(t(this._parent),this._parent.forEachParent(t))}forEachChildrenRecursive(t){this.children.forEach((e=>{t(e),0!==e.children.size&&e.forEachChildrenRecursive(t)}))}get destroyed(){return this._destroyed}_setup(t,e){this.destroyed&&(this._activeSelf=!0,this._setActive(!0),this._destroyed=!1,this._parent=e,this.name=t)}_destroy(){this.destroyed||(this._setActive(!1),this._destroyed=!0,this._componentMap.clear(),this._tagIndexMap.clear(),this.parent=null)}}class x{constructor(t,e){this.availableObjects=[],this.totalObjects=0,this.objectClass=t,this.objectManager=e}aquire(){0===this.availableObjects.length&&this.reserve(Math.ceil(1.2*this.totalObjects)-this.totalObjects);return this.availableObjects.pop()}release(t){this.availableObjects.push(t)}reserve(t){for(let e=0;e<t;e++)this.availableObjects.push(new this.objectClass(e+this.totalObjects,this.objectManager));this.totalObjects+=t}}class _{constructor(){this.systems=[],this.children=new Map,this._typeNameToSystem=new Map,this._tagToEntities=new Map,this.entityPool=new x(d,this),this.entityPool.reserve(100)}createEntity(t,e=this){const s=this.entityPool.aquire();return s._setup(null!=t?t:`Unnamed Entity ${s.id}`,e),s}destroyEntity(t){t._destroy(),this.entityPool.release(t),t.forEachChildrenRecursive((t=>{t._destroy(),this.entityPool.release(t)}))}getEntitesByTag(t){return r(this._tagToEntities,t,Array)}_entityComponentAdd(t,e){r(this._typeNameToSystem,e,Array).forEach((e=>{t._systemIndexMap.has(e.constructor.name)||t.hasAllComponents(e.typeNames)&&(t._systemIndexMap.set(e.constructor.name,e.entities.length),e.entities.push(t),void 0!==e.onEntityAdd&&e.onEntityAdd(t))}))}_entityComponentRemove(t,e){r(this._typeNameToSystem,e,Array).forEach((e=>{const s=t._systemIndexMap.get(e.constructor.name);if(void 0===s)return;i(e.entities,s)._systemIndexMap.set(e.constructor.name,s),t._systemIndexMap.delete(e.constructor.name)}))}_entityTagRemove(t,e){const s=r(this._tagToEntities,e,Array),n=t._tagIndexMap.get(e);i(s,n)._tagIndexMap.set(e,n),t._tagIndexMap.delete(e)}_entityTagAdd(t,e){const s=r(this._tagToEntities,e,Array);s.push(t),t._tagIndexMap.set(e,s.length-1)}_systemTypeNameAdd(t,e){r(this._typeNameToSystem,e,Array).push(t),t.typeNames.push(e)}}function y(t,e,s=.001){return Math.abs(t-e)<=s}const p=Math.PI/180;const m=180/Math.PI;const v=2*Math.PI;class f{constructor(t=0,e=0){this._array=null,this.x=t,this.y=e}set(t=0,e=0){return this.x=t,this.y=e,this}setVector(t){return this.x=t.x,this.y=t.y,this}clone(){return new f(this.x,this.y)}toString(){return`Vector2(${this.x}, ${this.y})`}toArray(t){this._array||(this._array=new Float32Array(2));const e=null!=t?t:this._array;return e[0]=this.x,e[1]=this.y,e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}multiply(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t,this.y/=t,this}distanceSquared(t){const e=this.x-t.x,s=this.y-t.y;return Math.pow(e,2)+Math.pow(s,2)}distance(t){return Math.sqrt(this.distanceSquared(t))}magnitudeSquared(){return Math.pow(this.x,2)+Math.pow(this.y,2)}magnitude(){return Math.sqrt(this.magnitudeSquared())}normalize(){return this.divide(this.magnitude()),this}dot(t){return this.x*t.x+this.y+t.y}cross(t){return this.x*t.y-this.y*t.x}random(t=1){const e=Math.random()*Math.PI*2;return this.x=Math.cos(e)*t,this.y=Math.cos(e)*t,this}rotate(t,e=new f){const s=this.x-e.x,r=this.y-e.y,i=Math.sin(t),n=Math.cos(t);return this.x=s*n-r*i+e.x,this.y=s*i+r*n+e.y,this}angle(t=new f){return Math.atan2(this.y-this.y,t.x-t.x)}exactEquals(t){return this.x===t.x&&this.y===t.y}approxEquals(t,e=.001){return y(this.x,t.x,e)&&y(this.y,t.y,e)}transformMatrix3(t){const e=this.x;return this.x=t.xScale*e+t.xSkew*this.y+t.xTrans,this.y=t.ySkew*e+t.yScale*this.y+t.yTrans,this}}class g{constructor(){this.handled=!1}}class S{constructor(){this.eventListenersMap=new Map}addListener(t,e){var s;const i=null!==(s=t.name)&&void 0!==s?s:t;r(this.eventListenersMap,i,Array).push(e)}sendEvent(t){const e=t.constructor.name,s=r(this.eventListenersMap,e,Array);for(let e=0;e<s.length&&!t.handled;e++)s[e](t)}}class w extends g{constructor(t,e){super(),this.code=t,this.repeated=e}}class E extends g{constructor(t){super(),this.code=t}}class T extends g{constructor(t){super(),this.key=t}}class M extends g{constructor(t){super(),this.button=t}}class A extends g{constructor(t){super(),this.button=t}}class C extends g{constructor(t,e){super(),this.offsetX=t,this.offsetY=e}}class b extends g{constructor(t,e){super(),this.offsetX=t,this.offsetY=e}}class R extends g{constructor(t,e){super(),this.width=t,this.height=e}}class k{constructor(t={},e){var s,r,i,n;this._pressedKeys=new Map,this._pressedMouseButtons=new Map,this._mousePosition=new f,this.fixedSize=null===(s=t.fixedSize)||void 0===s||s,this._eventManager=e,this.aspectRatio=null!==(r=t.aspectRatio)&&void 0!==r?r:null,this.element=document.createElement("canvas"),this.fixedSize?this.resizeCanvas(null!==(i=t.width)&&void 0!==i?i:400,null!==(n=t.height)&&void 0!==n?n:400):this.resizeFull(),window.addEventListener("keydown",(t=>{this._pressedKeys.set(t.code,!0),this._eventManager.sendEvent(new w(t.code,t.repeat))})),window.addEventListener("keyup",(t=>{this._pressedKeys.set(t.code,!1),this._eventManager.sendEvent(new E(t.code))})),window.addEventListener("keypress",(t=>{this._eventManager.sendEvent(new T(t.key))})),window.addEventListener("mousedown",(t=>{this._eventManager.sendEvent(new M(t.button)),this._pressedMouseButtons.set(t.button,!0)})),window.addEventListener("mouseup",(t=>{this._eventManager.sendEvent(new A(t.button)),this._pressedMouseButtons.set(t.button,!1)})),window.addEventListener("mousemove",(t=>{this._eventManager.sendEvent(new C(t.offsetX,t.offsetY)),this._mousePosition.set(t.clientX,t.clientY)})),window.addEventListener("wheel",(t=>{this._eventManager.sendEvent(new b(t.offsetX,t.offsetY))})),window.addEventListener("resize",(()=>{this.fixedSize||this.resizeFull()}))}resizeCanvas(t,e,s=!0){this.width=t,this.height=e,this.element.width=t,this.element.height=e,s&&this._eventManager.sendEvent(new R(t,e))}isKeyPressed(t){var e;return null!==(e=this._pressedKeys.get(t))&&void 0!==e&&e}isMousePressed(t){var e;return null!==(e=this._pressedMouseButtons.get(t))&&void 0!==e&&e}getMousePosition(){return this._mousePosition.clone()}resizeFull(){if(null!==this.aspectRatio){let t=window.innerHeight;const e=window.innerWidth/this.aspectRatio;e<t&&(t=e),this.resizeCanvas(t*this.aspectRatio,t)}else this.resizeCanvas(window.innerWidth,window.innerHeight)}}class I{constructor(t,e){this.volume=1,this.loop=!1,this.playing=!1,this.source=null,this.gain=null,this.buffer=t,this._context=e}static fromURL(t,s){return e(this,void 0,void 0,(function*(){const e=yield fetch(t),r=yield e.arrayBuffer(),i=yield s.decodeAudioData(r);return new I(i,s)}))}play(){const t=this._context.createBufferSource();t.buffer=this.buffer,t.start(this._context.currentTime),t.loop=this.loop,t.onended=()=>this.playing=!1;const e=this._context.createGain();t.connect(e),e.connect(this._context.destination),e.gain.value=this.volume,this.playing=!0,this.source=t,this.gain=e}stop(){this.source.stop(this._context.currentTime)}toggle(){this.playing?this.stop():this.play()}}class P{constructor(t){this.glTexture=null,this.source=t,this.aspectRatio=this.source.width/this.source.height}init(t){this.glTexture=t.createTexture(),this.bind(t),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.source.width,this.source.height,0,t.RGBA,t.UNSIGNED_BYTE,this.source)}bind(t,e){e&&t.activeTexture(t.TEXTURE0+e),null===this.glTexture?this.init(t):t.bindTexture(t.TEXTURE_2D,this.glTexture)}dispose(t){t.deleteTexture(this.glTexture),this.glTexture=null}static fromURL(t){return e(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{const r=new Image;r.src=t,r.onload=()=>{const t=new P(r);e(t)},r.onerror=t=>s(t)}))}))}}P.WHITE=function(){const t=document.createElement("canvas");t.width=16,t.height=16;const e=t.getContext("2d");return e.fillStyle="white",e.fillRect(0,0,16,16),new P(t)}();class L{constructor(t){this.resourceURLs=[],this.resources={},this._audioContext=t}add(t,e){var s;const r=null!==(s=t.name)&&void 0!==s?s:t;return this.resourceURLs.push([r,e]),this}loadAll(){return e(this,void 0,void 0,(function*(){for(const[t,e]of this.resourceURLs)switch(t){case"AudioClip":this.resources[e]=yield I.fromURL(e,this._audioContext);break;case"Texture":this.resources[e]=yield P.fromURL(e)}this.resourceURLs=[]}))}}class B extends g{}class F extends g{constructor(t){super(),this.delta=t}}class U{constructor(t=1,e=0,s=0,r=1,i=0,n=0){this._array=null,this.xScale=t,this.ySkew=e,this.xSkew=s,this.yScale=r,this.xTrans=i,this.yTrans=n}clone(){return new U(this.xScale,this.ySkew,this.xSkew,this.yScale,this.xTrans,this.yTrans)}toString(){return`Matrix3(\n\t${this.xScale}, ${this.xSkew}, ${this.xTrans},\n\t${this.ySkew}, ${this.yScale}, ${this.yTrans},\n\t0, 0, 1\n)`}toArray(t=!0,e){this._array||(this._array=new Float32Array(9));const s=null!=e?e:this._array;return t?(s[0]=this.xScale,s[1]=this.ySkew,s[2]=0,s[3]=this.xSkew,s[4]=this.yScale,s[5]=0,s[6]=this.xTrans,s[7]=this.yTrans,s[8]=1):(s[0]=this.xScale,s[1]=this.xSkew,s[2]=this.xTrans,s[3]=this.ySkew,s[4]=this.yScale,s[5]=this.yTrans,s[6]=0,s[7]=0,s[8]=1),s}invert(){const t=this.xScale,e=this.ySkew,s=this.xSkew,r=this.yScale,i=this.xTrans,n=t*r-e*s;return 0===n||(this.xScale=r/n,this.ySkew=-e/n,this.xSkew=-s/n,this.yScale=t/n,this.xTrans=(s*this.yTrans-r*i)/n,this.yTrans=-(t*this.yTrans-s*i)/n),this}identity(){return this.xScale=1,this.ySkew=0,this.xSkew=0,this.yScale=1,this.xTrans=0,this.yTrans=0,this}multiply(t){const e=this.xScale,s=this.ySkew,r=this.xSkew,i=this.yScale;return this.xScale=e*t.xScale+r*t.ySkew,this.ySkew=s*t.xScale+i*t.ySkew,this.xSkew=e*t.xSkew+r*t.yScale,this.yScale=s*t.xSkew+i*t.yScale,this.xTrans=e*t.xTrans+r*t.yTrans+this.xTrans,this.yTrans=s*t.xTrans+i*t.yTrans+this.yTrans,this}multiplyFront(t){const e=this.xTrans;if(1!==t.xScale||0!==t.ySkew||0!==t.xSkew||1!==t.yScale){const e=this.xScale,s=this.xSkew;this.xScale=e*t.xScale+this.ySkew*t.xSkew,this.ySkew=e*t.ySkew+this.ySkew*t.yScale,this.xSkew=s*t.xScale+this.yScale*t.xSkew,this.yScale=s*t.ySkew+this.yScale*t.yScale}return this.xTrans=e*t.xScale+this.yTrans*t.xSkew+t.xTrans,this.yTrans=e*t.ySkew+this.yTrans*t.yScale+t.yTrans,this}translate(t,e){return this.xTrans+=t,this.yTrans+=e,this}scale(t,e){return this.xScale*=t,this.yScale*=e,this.xSkew*=t,this.ySkew*=e,this.xTrans*=t,this.yTrans*=e,this}rotate(t){const e=Math.cos(t),s=Math.sin(t),r=this.xScale,i=this.xSkew,n=this.xTrans;return this.xScale=r*e-this.ySkew*s,this.ySkew=r*s+this.ySkew*e,this.xSkew=i*e-this.yScale*s,this.yScale=i*s+this.yScale*e,this.xTrans=n*e-this.yTrans*s,this.yTrans=n*s+this.yTrans*e,this}transform(t,e,s){return this.identity(),0!==s&&this.rotate(s),this.translate(t.x,t.y).scale(e.x,e.y),this}projection(t,e,s,r){const i=e-t,n=r-s;return this.xScale=2/i,this.yScale=2/n,this.xTrans=(e+t)/i,this.yTrans=(r+s)/n,this.xSkew=0,this.ySkew=0,this}}class V{constructor(t=5,e=!1){this.aspectRatio=0,this._projectionMatrix=new U,this.size=t,this.fixedAspectRatio=e}setViewportSize(t,e){this.aspectRatio=t/e}getProjectionMatrix(){return this._projectionMatrix.projection(-this.size*this.aspectRatio,this.size*this.aspectRatio,this.size,-this.size)}}class D{constructor(t,e=16777215){this.texture=t,this.color=e}set color(t){this._hexColor=t,this.rgbaColor=u(t)}get color(){return this._hexColor}}class z{constructor(t=new f,e=new f(1,1),s=0){this._transformMatrix=new U,this._transformValid=!1,this._position=t,this._scale=e,this._rotation=s}get transformMatrix(){return this._transformValid||(this._transformMatrix.transform(this._position,this._scale,this._rotation),this._transformValid=!0),this._transformMatrix}set rotation(t){this._transformValid=!1,this._rotation=t}get rotation(){return this._rotation}set position(t){this._transformValid=!1,this._position=t}get position(){return this._transformValid=!1,this._position}set scale(t){this._transformValid=!1,this._scale=t}get scale(){return this._transformValid=!1,this._scale}static getGlobalPosition(t){const e=t.getComponent(z)._position.clone();return t.forEachParent((t=>{e.add(t.getComponent(z)._position)})),e}static getGlobalScale(t){const e=t.getComponent(z)._scale.clone();return t.forEachParent((t=>{e.add(t.getComponent(z)._scale)})),e}static getGlobalRotation(t){let e=t.getComponent(z)._rotation;return t.forEachParent((t=>{e+=t.getComponent(z)._rotation})),e}static getGlobalTransformMatrix(t){const e=t.getComponent(z).transformMatrix;return t.forEachParent((t=>{e.multiplyFront(t.getComponent(z).transformMatrix)})),e}}class N{constructor(t){this.entities=[],this.typeNames=[],this.scene=t}setComponents(t){for(const e of t){const t=n(e);this.scene._systemTypeNameAdd(this,t)}}}class j{constructor(t,e,s="Default"){this.glProgram=null,this.uniformLocationCache=new Map,this.vertexSrc=t,this.fragmentSrc=e,this.name=s}init(t){const e=this._compileGLShader(t,t.VERTEX_SHADER,this.vertexSrc),s=this._compileGLShader(t,t.FRAGMENT_SHADER,this.fragmentSrc);if(this.glProgram=t.createProgram(),t.attachShader(this.glProgram,e),t.attachShader(this.glProgram,s),t.linkProgram(this.glProgram),!t.getProgramParameter(this.glProgram,t.LINK_STATUS)){const e=t.getProgramInfoLog(this.glProgram);throw new Error(`Program failed to link in '${this.name}' shader!\n${e}`)}t.deleteShader(e),t.deleteShader(s)}bind(t){this.glProgram||this.init(t),t.useProgram(this.glProgram)}dispose(t){t.deleteProgram(this.glProgram)}getUniformLocation(t,e){const s=this.uniformLocationCache.get(e);if(void 0!==s)return s;const r=t.getUniformLocation(this.glProgram,e);return this.uniformLocationCache.set(e,r),r}setFloat1(t,e,s){t.uniform1f(this.getUniformLocation(t,e),s)}setFloat2(t,e,s){t.uniform2f(this.getUniformLocation(t,e),s.x,s.y)}setInt1(t,e,s){t.uniform1i(this.getUniformLocation(t,e),s)}setIntArray(t,e,s){t.uniform1iv(this.getUniformLocation(t,e),s)}setMatrix3(t,e,s){t.uniformMatrix3fv(this.getUniformLocation(t,e),!1,s.toArray(!0))}_compileGLShader(t,e,s){const r=t.createShader(e),i=e===t.VERTEX_SHADER?"vertex":"fragment";if(t.shaderSource(r,s),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);throw new Error(`Failed to compile ${i} shader in '${this.name}' shader!\n${e}`)}return r}}class G{constructor(t){this.glIndexBuffer=null,this.glVertexBuffers=[];const e=t.createVertexArray();this.glVertexArray=e}bind(t){t.bindVertexArray(this.glVertexArray)}addVertexBuffer(t,e,s=WebGL2RenderingContext.STATIC_DRAW){this.bind(t);const r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,s),this.glVertexBuffers.push(r),r}setIndexBuffer(t,e){this.bind(t);const s=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,t.STATIC_DRAW),this.glIndexBuffer=s,s}dispose(t){this.glVertexBuffers.forEach((e=>{t.deleteBuffer(e)})),t.deleteBuffer(this.glIndexBuffer),t.deleteVertexArray(this.glVertexArray)}}class O{constructor(t){this.textureToSlotMap=new Map,this.vertices=new Float32Array(O.maxVertices),this.indices=new Uint16Array(O.maxIndices),this.verticesIndex=0,this.indicesCount=0,this.textureSlotIndex=0,this.renderer=t;const e=t.gl;this.vertexArray=new G(e),this.vertexBuffer=this.vertexArray.addVertexBuffer(e,this.vertices,e.DYNAMIC_DRAW);for(let t=0,e=0;t<O.maxIndices;t+=6,e+=4)this.indices[t]=e,this.indices[t+1]=e+1,this.indices[t+2]=e+2,this.indices[t+3]=e+2,this.indices[t+4]=e+3,this.indices[t+5]=e;this.vertexArray.setIndexBuffer(e,this.indices);const s=O.vertexSize*Float32Array.BYTES_PER_ELEMENT;e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,s,0),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,s,2*Float32Array.BYTES_PER_ELEMENT),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,1,e.FLOAT,!1,s,4*Float32Array.BYTES_PER_ELEMENT),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,4,e.FLOAT,!1,s,5*Float32Array.BYTES_PER_ELEMENT),this.textureShader=new j("#version 300 es\n\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in float a_texIndex;\nlayout(location = 3) in vec4 a_color;\n\nuniform mat3 u_viewProjection;\n\nout vec2 v_texCoord;\nout float v_texIndex;\nout vec4 v_color;\n\nvoid main() \n{\n    v_texCoord = a_texCoord;\n    v_texIndex = a_texIndex;\n    v_color = a_color;\n\n    gl_Position = vec4(u_viewProjection * vec3(a_position, 1.0), 1.0);\n}\n","#version 300 es\n\nprecision mediump float;\n\nlayout(location = 0) out vec4 color;\n\nin vec2 v_texCoord;\nin float v_texIndex;\nin vec4 v_color;\n\nuniform sampler2D u_textures[32];\n\nvoid main() \n{\n    vec4 texColor = v_color;\n    vec2 coordinate = v_texCoord;\n\n    // have to use switch because WebGL doesn't support dynamic sampler indexing\n    switch(int(v_texIndex))\n\t{\n\t\tcase 0: texColor *= texture(u_textures[0], coordinate); break;\n\t\tcase 1: texColor *= texture(u_textures[1], coordinate); break;\n\t\tcase 2: texColor *= texture(u_textures[2], coordinate); break;\n\t\tcase 3: texColor *= texture(u_textures[3], coordinate); break;\n\t\tcase 4: texColor *= texture(u_textures[4], coordinate); break;\n\t\tcase 5: texColor *= texture(u_textures[5], coordinate); break;\n\t\tcase 6: texColor *= texture(u_textures[6], coordinate); break;\n\t\tcase 7: texColor *= texture(u_textures[7], coordinate); break;\n\t\tcase 8: texColor *= texture(u_textures[8], coordinate); break;\n\t\tcase 9: texColor *= texture(u_textures[9], coordinate); break;\n\t\tcase 10: texColor *= texture(u_textures[10], coordinate); break;\n\t\tcase 11: texColor *= texture(u_textures[11], coordinate); break;\n\t\tcase 12: texColor *= texture(u_textures[12], coordinate); break;\n\t\tcase 13: texColor *= texture(u_textures[13], coordinate); break;\n\t\tcase 14: texColor *= texture(u_textures[14], coordinate); break;\n\t\tcase 15: texColor *= texture(u_textures[15], coordinate); break;\n\t\tcase 16: texColor *= texture(u_textures[16], coordinate); break;\n\t\tcase 17: texColor *= texture(u_textures[17], coordinate); break;\n\t\tcase 18: texColor *= texture(u_textures[18], coordinate); break;\n\t\tcase 19: texColor *= texture(u_textures[19], coordinate); break;\n\t\tcase 20: texColor *= texture(u_textures[20], coordinate); break;\n\t\tcase 21: texColor *= texture(u_textures[21], coordinate); break;\n\t\tcase 22: texColor *= texture(u_textures[22], coordinate); break;\n\t\tcase 23: texColor *= texture(u_textures[23], coordinate); break;\n\t\tcase 24: texColor *= texture(u_textures[24], coordinate); break;\n\t\tcase 25: texColor *= texture(u_textures[25], coordinate); break;\n\t\tcase 26: texColor *= texture(u_textures[26], coordinate); break;\n\t\tcase 27: texColor *= texture(u_textures[27], coordinate); break;\n\t\tcase 28: texColor *= texture(u_textures[28], coordinate); break;\n\t\tcase 29: texColor *= texture(u_textures[29], coordinate); break;\n\t\tcase 30: texColor *= texture(u_textures[30], coordinate); break;\n\t\tcase 31: texColor *= texture(u_textures[31], coordinate); break;\n\t}\n\n    color = texColor;\n}\n","Sprite"),this.textureShader.bind(e);const r=new Int32Array(t.maxTextureSlots).map(((t,e)=>e));this.textureShader.setIntArray(e,"u_textures",r),this.textureSlots=new Array(t.maxTextureSlots).fill(void 0)}beginScene(t){const e=this.renderer.gl;this.textureShader.bind(e),this.textureShader.setMatrix3(e,"u_viewProjection",t),this.startBatch()}endScene(){this.flush()}startBatch(){this.verticesIndex=0,this.indicesCount=0}nextBatch(){this.flush(),this.startBatch(),this.textureSlotIndex=0}flush(){if(0===this.indicesCount||0===this.verticesIndex)return;const t=this.renderer.gl,e=this.verticesIndex===O.maxVertices?this.vertices:this.vertices.subarray(0,this.verticesIndex);t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e);for(let e=0;e<this.textureSlotIndex;e++)this.textureSlots[e].bind(t,e);this.vertexArray.bind(t),t.drawElements(t.TRIANGLES,this.indicesCount,t.UNSIGNED_SHORT,0)}getTextureSlot(t){let e=this.textureToSlotMap.get(t);return void 0===e&&(this.textureSlotIndex>=this.renderer.maxTextureSlots&&this.nextBatch(),e=this.textureSlotIndex,this.textureSlots[this.textureSlotIndex]=t,this.textureToSlotMap.set(t,this.textureSlotIndex),this.textureSlotIndex++),e}}O.vertexSize=9,O.maxDraws=1e3,O.maxVertices=4*O.maxDraws*O.vertexSize,O.maxIndices=6*O.maxDraws,O.maxVerticesBytes=O.maxVertices*Float32Array.BYTES_PER_ELEMENT;class X extends O{constructor(){super(...arguments),this._cacheVector=new f}drawSprite(t){this.indicesCount>=O.maxIndices&&this.nextBatch();const e=z.getGlobalTransformMatrix(t),s=t.getComponent(D);for(let t=0;t<4;t++){const r=2*t;this._cacheVector.set(X.vertexPositions[r]*s.texture.aspectRatio,X.vertexPositions[r+1]).transformMatrix3(e),this.vertices[this.verticesIndex++]=this._cacheVector.x,this.vertices[this.verticesIndex++]=this._cacheVector.y,this.vertices[this.verticesIndex++]=X.texCoords[r],this.vertices[this.verticesIndex++]=X.texCoords[r+1],this.vertices[this.verticesIndex++]=this.getTextureSlot(s.texture),this.vertices[this.verticesIndex++]=s.rgbaColor[0],this.vertices[this.verticesIndex++]=s.rgbaColor[1],this.vertices[this.verticesIndex++]=s.rgbaColor[2],this.vertices[this.verticesIndex++]=s.rgbaColor[3]}this.indicesCount+=6}}X.vertexPositions=new Float32Array([-.5,-.5,.5,-.5,.5,.5,-.5,.5]),X.texCoords=new Float32Array([0,0,1,0,1,1,0,1]);if(window.__ESSEM__)throw new Error("essem.js is already imported!");window.__ESSEM__=!0,t.AbstractBatchRenderer=O,t.Application=class{constructor(t={}){this.audioContext=new AudioContext,this.eventManager=new S,this.lastFrameTime=0,this.running=!0,this._systemClasses=[],this.canvas=new k(t.canvasOptions,this.eventManager),this.loader=new L(this.audioContext),this.renderer=new l(this.canvas.element),setTimeout((()=>e(this,void 0,void 0,(function*(){yield this.loader.loadAll(),this.eventManager.sendEvent(new B),this.eventManager.addListener(R,(t=>{this.renderer.gl.viewport(0,0,t.width,t.height)})),c();const t=()=>{this.running&&(this._onUpdate(),requestAnimationFrame(t))};requestAnimationFrame(t)}))))}_onUpdate(){const t=performance.now(),e=t-this.lastFrameTime;this.renderer.update(),this.eventManager.sendEvent(new F(e)),this.lastFrameTime=t}registerSystem(...t){this._systemClasses.push(...t)}createScene(){const t=new _,e=[];return this._systemClasses.forEach((s=>{const r=new s(t);r.setup(this),e.push(r)})),t.systems=e,t}},t.ApplicationInitEvent=B,t.ApplicationUpdateEvent=F,t.AssertionError=s,t.AudioClip=I,t.CameraComponent=V,t.CameraSystem=class extends N{setup(t){this.setComponents([z,V]),t.eventManager.addListener(R,this.onResized.bind(this)),this.canvas=t.canvas}onEntityAdd(t){const e=t.getComponent(V);e.fixedAspectRatio||e.setViewportSize(this.canvas.width,this.canvas.height)}onResized(t){this.entities.forEach((e=>{const s=e.getComponent(V);s.fixedAspectRatio||s.setViewportSize(t.width,t.height)}))}},t.Canvas=k,t.CanvasResizedEvent=R,t.DEG_TO_RAD=p,t.Entity=d,t.Event=g,t.EventManager=S,t.KeyPressedEvent=w,t.KeyReleasedEvent=E,t.KeyTypedEvent=T,t.Loader=L,t.Matrix3=U,t.MouseMovedEvent=C,t.MousePressedEvent=M,t.MouseReleasedEvent=A,t.MouseScrolledEvent=b,t.RAD_TO_DEG=m,t.Renderer=l,t.Scene=_,t.Shader=j,t.SpriteComponent=D,t.SpriteRenderer=X,t.SpriteRendererSystem=class extends N{setup(t){this.setComponents([z,D]),t.eventManager.addListener(F,this.onUpdate.bind(this)),this.spriteRenderer=new X(t.renderer)}onUpdate(){const t=this.scene.getEntitesByTag("MainCamera")[0];if(void 0===t)return;const e=t.getComponent(V).getProjectionMatrix();e.multiply(t.getComponent(z).transformMatrix.invert()),this.spriteRenderer.beginScene(e),this.entities.forEach((t=>{this.spriteRenderer.drawSprite(t)})),this.spriteRenderer.endScene()}},t.System=N,t.TWO_PI=v,t.Texture=P,t.TransformComponent=z,t.VERSION="0.0.0",t.Vector2=f,t.VertexArray=G,t.approxEquals=y,t.assert=function(t,e){if(!t)throw new s(e)},t.getTypeName=n,t.hexToRGBA=u,t.isWebGL2Supported=a,t.lastItemSwapRemove=i,t.mapGet=r,t.sayHello=c,t.skipHello=function(){h=!0},t.toDegrees=function(t){return t*m},t.toRadians=function(t){return t*p},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=essem.min.js.map
